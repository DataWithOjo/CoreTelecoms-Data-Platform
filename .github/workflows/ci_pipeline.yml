name: CoreTelecoms CI Pipeline

on:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  push:
    branches: [ "**" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  quality-checks:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Linting Tools
        run: pip install flake8 sqlfluff sqlfluff-templater-dbt dbt-snowflake

      - name: Lint Python Code (DAGs & Scripts)
        run: |
          flake8 dags scripts --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Lint SQL Code (dbt Models)
        env:
          DBT_PROFILES_DIR: ${{ github.workspace }}/dbt_core_telecoms
        run: |
          DBT_DIR=$(cd $(dirname $(find . -name dbt_project.yml -type f | head -n 1)) && pwd)
          echo "Detected dbt project at: $DBT_DIR"
          ls -la "$DBT_DIR"

          # Create dummy profiles.yml with target none
          cat <<'EOF' > "$DBT_DIR/profiles.yml"
          core_telecoms:
            target: none
            outputs:
              none:
                type: snowflake
                account: dummy
                user: dummy
                password: dummy
                role: dummy
                warehouse: dummy
                database: dummy
                schema: dummy
                threads: 1
                client_session_keep_alive: false
          EOF

          echo "=== dbt_project.yml ==="
          sed -n '1,200p' "$DBT_DIR/dbt_project.yml"
          echo "=== profiles.yml ==="
          sed -n '1,200p' "$DBT_DIR/profiles.yml"

          # Install packages from packages.yml
          cd "$DBT_DIR"
          dbt deps --profiles-dir .
          cd -

          # Confirm dbt picks up the right profile file
          export DBT_PROFILES_DIR="$DBT_DIR"
          dbt debug --project-dir "$DBT_DIR" --profiles-dir "$DBT_DIR" || true

          # Try a compile with target none and verbose logging
          dbt compile --project-dir "$DBT_DIR" --profiles-dir "$DBT_DIR" --target none -v || true

          # If compile succeeded (exit 0), run sqlfluff. Otherwise dump a message.
          if dbt compile --project-dir "$DBT_DIR" --profiles-dir "$DBT_DIR" --target none >/dev/null 2>&1; then
            echo "dbt compile succeeded with target none â€” running sqlfluff"
            sqlfluff lint "$DBT_DIR/models" --dialect snowflake
          else
            echo "dbt compile failed (or attempted DB connection). Check above output for details."
            exit 1
          fi


  unit-tests:
    name: Unit Testing
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install apache-airflow pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Airflow DAG Unit Tests
        env:
          AIRFLOW_HOME: ${{ github.workspace }}
        run: |
          export PYTHONPATH="${PYTHONPATH}:${{ github.workspace }}"
          pytest tests/test_load_snowflake_pipeline.py
